<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Lotto Strategy - Pyramidal Algorithm Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#030712">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icons/icon-192.png"> 
    <style>
        /* Estilos base para el fondo y la fuente */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #030712; /* gray-950 */
        }
        /* Ocultar pantallas no activas */
        .screen:not(.active) {
            display: none;
        }
        /* Iconos de Lucide (usamos SVG o im√°genes si no estamos en React, pero por simplicidad se usa texto/emojis como placeholder) */
        .icon-globe::before { content: "üåç"; margin-right: 0.5rem; }
        .icon-right::before { content: "‚Üí"; }
        .icon-left::before { content: "‚Üê"; }
        .icon-dice::before { content: "üé≤"; margin-right: 0.5rem; }
        .icon-calc::before { content: "üßÆ"; margin-right: 0.5rem; }
        .icon-check::before { content: "‚úÖ"; margin-right: 0.5rem; }
        .icon-error::before { content: "‚ùå"; margin-right: 0.5rem; }
        .icon-export::before { content: "üìÑ"; margin-right: 0.5rem; }
        .icon-star::before { content: "‚≠ê"; margin-right: 0.5rem; }
        .icon-magic::before { content: "‚ú®"; margin-right: 0.5rem; }
        .icon-sim::before { content: "üìä"; margin-right: 0.5rem; }
        .icon-money::before { content: "üí∞"; margin-right: 0.5rem; }

        /* Estilos de bandera */
        .flag-icon {
            font-size: 2.5rem; /* Ajuste el tama√±o de la bandera */
            line-height: 1; /* Asegura que el emoji no tenga espacio extra */
        }
        
        /* Estilo para los n√∫meros base seleccionados (Generaci√≥n) */
        .selected-number-display {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f59e0b; /* amber-500 */
            color: #111827; /* gray-900 */
            font-weight: bold;
            margin: 4px;
            transition: all 0.2s;
        }

        /* Estilo para los botones de la cuadr√≠cula de n√∫meros principales (Generaci√≥n) */
        .grid-number-button {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.15s;
            background-color: #1f2937; /* gray-800 */
            color: #fff;
            border: 1px solid #374151; /* gray-700 */
            cursor: pointer;
        }
        .grid-number-button.selected {
            background-color: #f59e0b; /* amber-500 */
            color: #111827; /* gray-900 */
            border-color: #f59e0b;
            transform: scale(1.1);
        }
        .grid-number-button:hover:not(.selected):not([disabled]) {
            background-color: #4b5563; /* gray-600 */
        }
        .grid-number-button[disabled] {
            cursor: not-allowed;
            opacity: 0.4;
        }

        /* Estilo para los botones de la cuadr√≠cula de n√∫meros EXTRA (Generaci√≥n) */
        .grid-extra-number-button {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.15s;
            background-color: #dc2626; /* red-600 */
            color: #fff;
            border: 1px solid #ef4444; /* red-500 */
            cursor: pointer;
        }
        .grid-extra-number-button.selected {
            background-color: #facc15; /* yellow-400 */
            color: #111827; /* gray-900 */
            border-color: #eab308; /* yellow-600 */
            transform: scale(1.1);
        }
        .grid-extra-number-button:hover:not(.selected):not([disabled]) {
            background-color: #ef4444; /* red-500 */
        }
        .grid-extra-number-button[disabled] {
            cursor: not-allowed;
            opacity: 0.4;
        }
        /* Estilo para mostrar las bolas extra en los resultados */
        .extra-ball-display {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #dc2626; /* red-600 */
            color: #fff;
            font-weight: bold;
            font-size: 1rem;
            margin-left: 8px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /* Estilo para los n√∫meros del simulador (Ganadores) */
        .sim-number-button {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.15s;
            background-color: #3b82f6; /* blue-500 */
            color: #fff;
            border: 1px solid #60a5fa; /* blue-400 */
            cursor: pointer;
        }
        .sim-number-button.selected {
            background-color: #10b981; /* emerald-500 */
            color: #111827; /* gray-900 */
            border-color: #059669;
            transform: scale(1.1);
        }
        .sim-number-button:hover:not(.selected):not([disabled]) {
            background-color: #60a5fa; /* blue-400 */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-950 p-6 text-gray-200">

    <div class="max-w-5xl mx-auto">
        <div class="mb-8 text-center">
            <div class="text-4xl font-extrabold text-yellow-500">GLOBAL LOTTO PRO</div>
        </div>
        <div id="app-container">
            </div>
    </div>

    <script>
        // --- 1. DATOS GLOBALES ---
        const LOTTERIES = {
            "North America": {
                "United States": { flag: "üá∫üá∏", nativeName: "United States", lotteries: [
                    { name: "Powerball", type: "pick5", range: 69, extra: { name: "Powerball", range: 26, count: 1 } },
                    { name: "Mega Millions", type: "pick5", range: 70, extra: { name: "Mega Ball", range: 25, count: 1 } }
                ]},
                "Canada": { flag: "üá®üá¶", nativeName: "Canada", lotteries: [
                    { name: "Lotto 6/49", type: "pick6", range: 49 }
                ]}
            },
            "Europe": {
                "Transnational": { flag: "üá™üá∫", nativeName: "Europe", lotteries: [
                    { name: "EuroMillions", type: "pick5", range: 50, extra: { name: "Lucky Stars", range: 12, count: 2 } },
                    { name: "EuroJackpot", type: "pick5", range: 50, extra: { name: "Euro Numbers", range: 12, count: 2 } }
                ]},
                "Spain": { flag: "üá™üá∏", nativeName: "Espa√±a", lotteries: [
                    { name: "La Primitiva", type: "pick6", range: 49 }
                ]},
                "Italy": { flag: "üáÆüáπ", nativeName: "Italia", lotteries: [
                    { name: "SuperEnalotto", type: "pick6", range: 90 }
                ]},
                "United Kingdom": { flag: "üá¨üáß", nativeName: "United Kingdom", lotteries: [
                    { name: "UK National Lottery", type: "pick6", range: 59 }
                ]},
                "Germany": { flag: "üá©üá™", nativeName: "Deutschland", lotteries: [
                    { name: "Lotto 6 aus 49", type: "pick6", range: 49 }
                ]}
            },
            "South America": {
                "Brazil": { flag: "üáßüá∑", nativeName: "Brasil", lotteries: [
                    { name: "Mega-Sena", type: "pick6", range: 60 }
                ]},
                "Argentina": { flag: "üá¶üá∑", nativeName: "Argentina", lotteries: [
                    { name: "Loto", type: "pick6", range: 46 }
                ]},
                "Colombia": { flag: "üá®üá¥", nativeName: "Colombia", lotteries: [
                    { name: "Baloto", type: "pick5", range: 43, extra: { name: "Superbalota", range: 16, count: 1 } }
                ]}
            },
            "Asia": {
                "Philippines": { flag: "üáµüá≠", nativeName: "Philippines", lotteries: [
                    { name: "Grand Lotto 6/55", type: "pick6", range: 55 },
                    { name: "Ultra Lotto 6/58", type: "pick6", range: 58 }
                ]},
                "Hong Kong": { flag: "üá≠üá∞", nativeName: "È¶ôÊ∏Ø", lotteries: [
                    { name: "Mark Six", type: "pick6", range: 49 }
                ]},
                "Singapore": { flag: "üá∏üá¨", nativeName: "Singapore", lotteries: [
                    { name: "Toto", type: "pick6", range: 49 }
                ]}
            },
            "Oceania": {
                "Australia": { flag: "üá¶üá∫", nativeName: "Australia", lotteries: [
                    { name: "Oz Lotto", type: "pick6", range: 47 },
                    { name: "Powerball Australia", type: "pick6", range: 35, extra: { name: "Powerball", range: 20, count: 1 } }
                ]}
            },
            "Africa": {
                "South Africa": { flag: "üáøüá¶", nativeName: "South Africa", lotteries: [
                    { name: "South African Lotto", type: "pick6", range: 52 }
                ]}
            }
        };

        // --- F√≥rmulas Pick 5 y Pick 6 (Sin cambios) ---
        const FORMULAS_PICK5 = {
            8: [[1,2,4,7,8],[1,3,5,6,7],[2,3,4,6,8]],
            9: [[1,2,5,6,8],[1,2,3,4,7],[3,4,6,7,8],[1,3,6,7,9],[2,5,7,8,9],[1,3,4,5,9]],
            10: [[2,4,5,6,10],[1,5,6,7,9],[2,3,5,6,8],[1,3,5,9,10],[2,7,8,9,10],[4,5,7,8,10],[3,4,6,7,9],[1,3,6,8,10],[1,2,3,4,7],[1,2,4,8,9]],
            11: [[2,4,6,7,11],[2,3,5,6,10],[1,2,6,8,9],[1,3,4,10,11],[4,5,8,9,11],[3,7,8,9,10],[1,4,5,6,7],[3,6,7,9,11],[5,6,8,10,11],[2,3,4,7,8],[2,4,5,9,10],[1,2,7,10,11],[1,2,3,5,9],[1,3,4,6,8],[1,5,7,8,10]],
            12: [[1,2,4,6,9],[1,5,8,9,12],[1,3,9,10,11],[1,6,7,8,10],[1,4,7,11,12],[1,2,3,5,7],[3,6,7,9,12],[4,5,7,9,10],[2,7,8,9,11],[4,5,6,8,11],[2,5,6,10,12],[2,3,4,8,12],[3,4,6,10,11],[1,2,6,11,12],[1,2,4,8,10],[3,5,6,8,9],[8,9,10,11,12],[3,5,7,11,12],[2,4,5,9,11],[1,3,4,5,6]],
            13: [[1,2,3,4,5],[1,2,6,7,8],[1,2,9,10,11],[1,3,6,9,12],[1,3,7,10,13],[1,4,6,11,13],[1,4,8,10,12],[1,5,7,11,12],[1,5,8,9,13],[2,3,8,11,12],[2,4,7,9,12],[2,5,6,10,12],[2,3,6,9,13],[2,4,8,10,13],[2,5,7,11,13],[3,4,5,6,7],[3,4,8,9,11],[5,6,8,10,11],[6,7,8,12,13],[9,10,11,12,13],[3,4,5,12,13],[3,5,7,9,10],[4,6,7,9,10],[2,4,6,11,12],[2,5,8,9,12],[3,4,7,10,11],[1,3,6,8,10]],
            14: [[4,6,7,8,10],[1,3,7,10,12],[5,7,9,10,14],[5,6,7,11,12],[3,6,7,13,14],[4,7,9,12,13],[1,4,7,11,14],[3,7,8,9,11],[1,5,7,8,13],[1,6,9,10,11],[3,4,5,10,11],[8,10,11,12,14],[5,6,10,12,13],[1,4,10,13,14],[3,8,9,10,13],[3,4,6,8,12],[1,4,5,6,9],[1,8,9,12,14],[1,3,11,12,13],[5,9,11,13,14],[4,6,8,11,13],[3,5,6,8,14],[3,4,5,12,14],[4,9,10,11,12],[1,5,8,10,11],[3,4,6,9,14],[1,6,7,12,14],[2,7,10,11,13],[1,2,3,4,8],[2,5,8,9,12],[1,2,6,9,13],[2,3,5,6,7],[2,6,11,12,14],[2,4,7,8,14],[1,2,3,10,14]],
            15: [[1,2,3,4,5],[1,2,6,7,8],[1,2,9,10,11],[1,2,12,13,14],[1,3,6,9,12],[1,3,7,10,13],[1,3,8,11,14],[1,4,6,10,14],[1,4,7,9,15],[1,5,6,11,13],[1,5,8,10,12],[2,3,6,10,15],[2,3,7,9,14],[2,4,6,9,13],[2,4,7,10,12],[2,4,8,11,15],[2,5,7,13,15],[3,4,6,7,11],[3,4,8,9,10],[3,4,12,13,15],[3,5,9,11,15],[4,5,7,8,14],[4,9,11,12,14],[5,6,7,9,10],[5,6,12,14,15],[7,8,9,11,13],[7,10,11,14,15],[2,5,8,9,12],[2,8,10,13,14],[3,5,6,8,13],[3,7,8,12,15],[4,5,10,11,13],[6,8,9,14,15],[6,8,10,11,12],[9,10,12,13,15],[1,5,7,11,12],[1,5,9,13,14],[2,3,11,12,13],[2,5,6,11,14],[3,5,10,12,14],[6,7,12,13,14],[1,4,8,12,13]]
        };

        const FORMULAS_PICK6 = {
            9: [[1,2,3,5,6,8],[1,2,4,5,6,9],[1,2,5,6,7,9],[1,3,4,5,6,7],[1,3,5,6,8,9],[1,4,5,6,7,8],[2,3,4,7,8,9]],
            10: [[1,2,4,5,7,9],[2,4,6,7,8,10],[1,2,3,6,8,9],[3,5,7,8,9,10],[2,4,5,6,9,10],[1,3,4,8,9,10],[3,4,5,6,7,8],[1,2,3,5,6,10],[1,3,6,7,9,10],[1,2,5,7,8,10]],
            11: [[2,3,4,6,7,9],[3,4,5,7,8,10],[4,5,6,8,9,11],[1,5,6,7,9,10],[2,6,7,8,10,11],[1,3,7,8,9,11],[1,2,4,8,9,10],[2,3,5,9,10,11],[1,3,4,6,10,11],[1,2,4,5,7,11],[1,2,3,5,6,8],[1,2,3,4,5,9],[1,2,3,6,7,10],[1,2,5,8,10,11],[1,4,5,6,7,8]],
            12: [[2,3,4,6,7,9],[3,4,5,7,8,10],[4,5,6,8,9,11],[1,5,6,7,9,12],[2,6,7,8,10,12],[1,3,7,8,9,11],[1,2,4,8,9,12],[2,3,5,9,10,11],[1,3,4,6,10,12],[1,2,4,5,7,11],[1,2,3,5,6,8],[1,2,4,10,11,12],[1,5,8,10,11,12],[3,5,6,7,11,12],[4,7,9,10,11,12],[2,3,4,8,11,12],[1,2,6,9,10,11],[3,6,8,9,10,12],[1,2,3,7,10,12],[2,4,5,6,10,12]],
            13: [[2,4,7,8,9,10],[4,6,7,10,11,12],[1,6,7,9,11,13],[2,5,6,8,9,10],[1,6,7,8,10,11],[1,2,4,6,10,13],[1,8,10,11,12,13],[5,7,8,9,10,13],[1,3,4,6,12,13],[3,4,6,10,12,13],[3,6,7,8,10,13],[4,5,6,8,9,10],[3,6,7,8,9,10],[1,4,5,6,8,10],[2,3,6,8,10,12],[4,5,6,10,11,13],[2,4,6,8,10,11],[4,5,6,8,9,11],[3,9,10,11,12,13],[4,5,7,9,11,12],[1,6,8,9,11,12],[2,3,5,6,9,10],[1,4,7,8,11,12],[4,6,7,8,12,13],[1,2,8,11,12,13],[2,5,6,9,11,13],[1,5,7,8,10,12],[1,3,4,5,8,9],[3,6,7,8,11,12],[4,5,6,8,9,12],[1,2,5,8,9,10],[3,6,7,8,10,11]],
            14: [[2,5,7,8,10,14],[4,5,6,7,10,12],[1,6,7,9,11,14],[2,5,6,9,10,14],[1,6,7,10,12,14],[2,4,6,10,13,14],[1,5,8,10,11,13],[5,7,8,9,13,14],[1,3,6,7,12,13],[3,4,6,8,13,14],[3,6,7,8,13,14],[4,5,6,8,10,14],[3,6,7,8,13,14],[3,4,5,6,8,10],[3,6,7,8,10,12],[4,5,6,10,11,13],[2,5,6,8,11,14],[2,4,5,6,11,14],[3,9,10,11,12,13],[1,4,7,9,11,12],[1,6,8,9,11,14],[3,5,6,9,10,14],[1,5,8,11,12,14],[1,6,7,8,12,13],[1,2,7,11,12,13],[2,7,9,11,13,14],[1,5,7,8,10,12],[1,3,4,5,8,9],[3,6,7,8,11,12],[4,5,6,8,9,12],[1,8,9,10,12,14],[3,7,8,9,10,11],[1,2,3,4,7,10],[1,2,3,5,13,14],[2,3,4,9,12,14],[2,4,8,10,11,12],[1,2,3,6,10,11],[1,2,4,6,9,13]],
            15: [[2,5,7,8,10,14],[4,6,7,8,10,12],[1,6,7,9,11,14],[2,5,6,9,10,14],[1,3,6,7,10,15],[2,4,6,10,12,13],[1,7,8,10,13,15],[2,5,7,8,13,14],[1,6,8,12,13,15],[3,4,6,13,14,15],[3,5,6,7,8,14],[3,4,5,6,8,10],[2,3,6,7,8,14],[4,5,6,8,10,11],[3,6,8,10,12,15],[4,5,6,10,11,15],[2,6,7,8,11,15],[3,4,5,6,11,14],[3,9,10,11,13,15],[4,7,9,11,12,13],[1,6,8,9,11,14],[3,5,6,9,10,14],[1,8,11,12,14,15],[6,7,8,12,13,15],[1,6,11,12,13,15],[2,4,9,11,13,14],[1,5,7,8,10,13],[3,4,5,8,9,11],[3,6,7,8,11,12],[4,5,6,8,9,12],[1,8,9,10,12,14],[1,2,3,4,5,7],[1,2,3,6,9,12],[1,2,3,8,10,11],[1,2,4,8,9,15],[1,2,5,10,12,15],[1,3,5,12,13,14],[2,3,4,11,12,15],[2,7,9,12,14,15],[1,2,5,6,11,13],[1,3,4,9,10,13],[1,4,5,7,14,15]],
            16: [[2,7,8,10,14,16],[4,6,7,10,12,16],[1,6,7,9,11,14],[2,5,6,9,10,14],[1,6,7,10,15,16],[2,4,6,10,13,16],[1,8,10,13,15,16],[5,7,8,13,14,16],[1,6,12,13,15,16],[3,4,6,13,14,16],[3,6,7,8,14,16],[4,5,6,8,10,16],[3,6,7,8,14,16],[4,5,6,8,10,16],[3,6,8,10,12,15],[4,5,6,10,11,15],[2,6,8,11,15,16],[4,5,6,11,14,16],[3,9,10,11,13,16],[4,7,9,11,12,16],[1,6,8,9,11,14],[3,5,6,9,10,14],[1,8,11,12,14,15],[6,7,8,12,13,15],[1,11,12,13,15,16],[2,9,11,13,14,16],[1,5,7,8,10,16],[3,4,5,8,9,16],[3,6,7,8,11,12],[4,5,6,8,9,12],[1,8,9,10,14,16],[3,7,8,10,11,16],[1,2,3,4,5,6],[1,2,3,7,8,9],[1,2,3,10,11,12],[1,2,3,13,14,15],[1,2,4,7,11,13],[1,2,4,8,12,16],[1,2,4,9,10,15],[1,2,5,7,12,14],[1,3,4,7,10,14],[1,3,4,9,12,13],[1,3,5,7,11,15],[1,5,10,11,13,14],[2,3,4,7,12,15],[2,3,4,8,11,14],[2,3,5,7,10,13],[2,3,6,9,12,16]]
        };
        // --- FIN DE F√ìRMULAS ---


        // --- CORE LOGIC: Mapeo de n√∫meros base a combinaciones finales ---
        function mapBaseNumbersToCombinations(baseNumbers, formula) {
            const finalBets = [];
            const sortedBaseNumbers = [...baseNumbers].sort((a, b) => a - b); 

            formula.forEach(combination => {
                const bet = combination.map(index => {
                    return sortedBaseNumbers[index - 1]; 
                });
                finalBets.push(bet);
            });
            return finalBets;
        }
        
        // Funci√≥n para generar n√∫meros aleatorios √∫nicos
        function getRandomUniqueNumbers(count, maxRange) {
            const numbers = new Set();
            while (numbers.size < count) {
                const num = Math.floor(Math.random() * maxRange) + 1;
                numbers.add(num);
            }
            return Array.from(numbers).sort((a, b) => a - b);
        }

        // --- FUNCIONALIDAD DE EXPORTACI√ìN (Sin cambios) ---
        function exportToTxt() {
            const lotto = state.selectedLottery;
            const combinations = state.finalCombinations;
            const extraNumbers = state.extraNumbers;
            
            if (!combinations || combinations.length === 0) {
                alert("No combinations to export.");
                return;
            }
            
            const extraInfo = extraNumbers.length > 0 
                ? `Extra Balls (${lotto.extra.name}): ${extraNumbers.join(', ')}`
                : "No extra balls selected/required.";

            const header = `--- Global Lotto Strategy Combinations ---\n`;
            const info = `Lottery: ${lotto.name}\nBase Numbers (${state.baseNumberCount}): ${state.baseNumbers.join(', ')}\nTotal Bets: ${combinations.length}\n${extraInfo}\n\n`;
            
            const combinationsText = combinations.map((bet, index) => {
                // Formato: N1, N2, N3, N4, N5 | E1, E2
                const mainNumbers = bet.join(', ');
                const extraPart = extraNumbers.length > 0 ? ` | ${extraNumbers.join(', ')}` : '';
                return `${mainNumbers}${extraPart}`; 
            }).join('\n');

            const footer = `\n--- END OF FILE ---\n\nDISCLAIMER: This file is for entertainment and theoretical strategy only and does not guarantee winnings. Gamble responsibly.`;

            const fileContent = header + info + combinationsText + footer;
            
            // Generar nombre de archivo (ej: Powerball_10Bases_20251124.txt)
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const filename = `${lotto.name.replace(/\s/g, '')}_${state.baseNumberCount}Bases_${date}.txt`;

            // Crear el blob y descargar el archivo
            const blob = new Blob([fileContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        // --- 2. GESTI√ìN DE ESTADO Y NAVEGACI√ìN ---
        let state = {
            screen: 'continent',
            // Datos para la generaci√≥n de apuestas
            selectedContinent: null,
            selectedCountry: null,
            selectedLottery: null,
            baseNumberCount: 0,
            baseNumbers: [], 
            finalCombinations: null,
            extraNumbers: [],
            // Datos para la simulaci√≥n
            simLottery: null,
            simBaseCount: 0,
            simBaseNumbers: [],
            simWinningNumbers: [],
            simWinningExtraNumbers: [],
            simResults: null,
        };

        const appContainer = document.getElementById('app-container');

        function updateState(newState) {
            state = { ...state, ...newState };
            renderApp();
        }

        function resetApp() {
            updateState({
                screen: 'continent',
                selectedContinent: null,
                selectedCountry: null,
                selectedLottery: null,
                baseNumberCount: 0,
                baseNumbers: [],
                finalCombinations: null,
                extraNumbers: [],
                simLottery: null,
                simBaseCount: 0,
                simBaseNumbers: [],
                simWinningNumbers: [],
                simWinningExtraNumbers: [],
                simResults: null,
            });
        }
        
        // --- FUNCIONES DE NAVEGACI√ìN PRINCIPAL ---

        function goToSimSelection() {
              updateState({ 
                screen: 'simLotterySelection', 
                simLottery: null, 
                simBaseCount: 0, 
                simBaseNumbers: [], 
                simWinningNumbers: [],
                simWinningExtraNumbers: []
            });
        }
        
        function backToContinentScreen() {
              updateState({ screen: 'continent' });
        }
        
        // --- MANEJADORES DE EVENTOS DE N√öMEROS BASE (Generaci√≥n) ---

        function addBaseNumber(num) {
            const count = state.baseNumberCount;

            // Comportamiento de toggle
            if (state.baseNumbers.includes(num)) {
                removeBaseNumber(num);
                return; 
            }
            
            // Validaci√≥n: L√≠mite alcanzado
            if (state.baseNumbers.length >= count) {
                alert(`Error: You have already selected the maximum of ${count} base numbers.`);
                return;
            }

            const newNumbers = [...state.baseNumbers, num];
            newNumbers.sort((a, b) => a - b); 

            state.baseNumbers = newNumbers; 
            renderNumberSelectionScreen(); 
        }

        function removeBaseNumber(num) {
            const newNumbers = state.baseNumbers.filter(n => n !== num);
            
            state.baseNumbers = newNumbers;
            renderNumberSelectionScreen(); 
        }

        // --- MANEJADORES DE EVENTOS DE N√öMEROS EXTRA (Generaci√≥n) ---
        function addExtraNumber(num) {
            const extra = state.selectedLottery.extra;

            // Comportamiento de toggle
            if (state.extraNumbers.includes(num)) {
                removeExtraNumber(num);
                return; 
            }
            
            // Validaci√≥n: L√≠mite alcanzado
            if (state.extraNumbers.length >= extra.count) {
                alert(`Error: You have already selected the maximum of ${extra.count} ${extra.name}.`);
                return;
            }

            const newNumbers = [...state.extraNumbers, num];
            newNumbers.sort((a, b) => a - b); 

            state.extraNumbers = newNumbers; 
            renderExtraNumbersSelectionScreen(); 
        }

        function removeExtraNumber(num) {
            const newNumbers = state.extraNumbers.filter(n => n !== num);
            
            state.extraNumbers = newNumbers;
            renderExtraNumbersSelectionScreen(); 
        }

        function autoSelectExtraNumbers() {
            const extra = state.selectedLottery.extra;
            const randomNumbers = getRandomUniqueNumbers(extra.count, extra.range);
            
            updateState({ extraNumbers: randomNumbers });
            // Redirigir a resultados despu√©s de la selecci√≥n autom√°tica
            calculateAndGoToResults();
        }
        
        function calculateAndGoToResults() {
            const count = state.baseNumberCount;
            
            const isPick5 = state.selectedLottery.type === 'pick5';
            const formula = isPick5 ? FORMULAS_PICK5[count] : FORMULAS_PICK6[count];

            const finalBets = mapBaseNumbersToCombinations(state.baseNumbers, formula);

            updateState({ finalCombinations: finalBets, screen: 'results' });
        }
        
        function generateMainBets() {
            const lotto = state.selectedLottery;
            const count = state.baseNumberCount;
            const selectedCount = state.baseNumbers.length;

            if (selectedCount !== count) {
                alert(`Error: You must select exactly ${count} numbers before proceeding.`);
                return;
            }
            
            if (lotto.extra) {
                // Si hay bolas extra, vamos a la pantalla de selecci√≥n de extras
                updateState({ screen: 'extraNumberSelection', extraNumbers: [] });
            } else {
                // Si no hay, generamos y vamos directamente a resultados
                calculateAndGoToResults();
            }
        }

        // --- MANEJADORES DE EVENTOS DE N√öMEROS (Simulador) ---
        
        function handleSimNumberSelection(number, type) {
            const lotto = state.simLottery;
            const baseCount = state.simBaseCount;
            const requiredMainCount = lotto.type === 'pick5' ? 5 : 6;
            
            // El count requerido es baseCount solo para los Base Numbers.
            // Para los Winning Numbers, el count es 5 o 6.
            const requiredCount = (type === 'base') ? baseCount : requiredMainCount; 
            
            const currentArray = (type === 'base') ? state.simBaseNumbers : state.simWinningNumbers;
            const stateKey = (type === 'base') ? 'simBaseNumbers' : 'simWinningNumbers';
            
            let newNumbers = [...currentArray];
            
            if (newNumbers.includes(number)) {
                // Quitar n√∫mero
                newNumbers = newNumbers.filter(n => n !== number);
            } else {
                // A√±adir n√∫mero
                if (newNumbers.length < requiredCount) {
                    newNumbers.push(number);
                } else {
                    alert(`Error: Already selected the required ${requiredCount} numbers for this field.`);
                }
            }
            
            newNumbers.sort((a, b) => a - b);
            
            // IMPORTANTE: Si los Base Numbers cambian, debemos resetear la selecci√≥n de Winning Numbers, 
            // ya que ahora la lista de ganadores permitidos ha cambiado.
            if (type === 'base') {
                // Filtramos los Winning Numbers que ya no est√°n en los nuevos Base Numbers
                const updatedWinningNumbers = state.simWinningNumbers.filter(num => newNumbers.includes(num));
                
                updateState({ 
                    simBaseNumbers: newNumbers, 
                    simWinningNumbers: updatedWinningNumbers // Aplicamos el filtro
                });
            } else {
                updateState({ [stateKey]: newNumbers });
            }
            // Note: renderApp is called by updateState, which will call renderSimNumberInputScreen
        }
        
        function handleSimExtraNumberSelection(number) {
            const extra = state.simLottery.extra;
            const requiredCount = extra.count;
            let newNumbers = [...state.simWinningExtraNumbers];
            
            if (newNumbers.includes(number)) {
                newNumbers = newNumbers.filter(n => n !== number);
            } else {
                if (newNumbers.length < requiredCount) {
                    newNumbers.push(number);
                } else {
                    alert(`Error: Already selected the required ${requiredCount} ${extra.name}.`);
                }
            }
            
            newNumbers.sort((a, b) => a - b);
            updateState({ simWinningExtraNumbers: newNumbers });
            // Note: renderApp is called by updateState, which will call renderSimNumberInputScreen
        }

        function goToSimResults() {
            const lotto = state.simLottery;
            const baseCount = state.simBaseCount;
            const numType = lotto.type;
            
            const requiredMainCount = numType === 'pick5' ? 5 : 6;
            const requiredExtraCount = lotto.extra ? lotto.extra.count : 0;
            
            // 1. Validaciones
            if (state.simBaseNumbers.length !== baseCount) {
                alert(`Error: Must select exactly ${baseCount} Base Numbers.`);
                return;
            }
            if (state.simWinningNumbers.length !== requiredMainCount) {
                alert(`Error: Must select exactly ${requiredMainCount} Winning Numbers.`);
                return;
            }
            if (requiredExtraCount > 0 && state.simWinningExtraNumbers.length !== requiredExtraCount) {
                alert(`Error: Must select exactly ${requiredExtraCount} Winning ${lotto.extra.name}.`);
                return;
            }
            
            // 2. Generar apuestas con la f√≥rmula
            const formula = numType === 'pick5' ? FORMULAS_PICK5[baseCount] : FORMULAS_PICK6[baseCount];
            const allGeneratedBets = mapBaseNumbersToCombinations(state.simBaseNumbers, formula);
            
            // 3. Comparar y contar aciertos
            const results = {
                totalBets: allGeneratedBets.length,
                mainHits: {}, 
                extraHits: {}, 
                totalMatches: {}, 
            };

            const winningMainSet = new Set(state.simWinningNumbers);
            const winningExtraSet = new Set(state.simWinningExtraNumbers);
            
            allGeneratedBets.forEach(bet => {
                const mainMatches = bet.filter(num => winningMainSet.has(num)).length;
                
                let extraMatches = 0;
                if (requiredExtraCount > 0) {
                    // Contar cu√°ntos n√∫meros extra seleccionados est√°n en los n√∫meros extra ganadores
                    extraMatches = state.simWinningExtraNumbers.filter(num => winningExtraSet.has(num)).length;
                }
                
                // Contar aciertos principales
                results.mainHits[mainMatches] = (results.mainHits[mainMatches] || 0) + 1;
                
                // Contar aciertos totales (principal + extra)
                const matchKey = `${mainMatches}+${extraMatches}`;
                results.totalMatches[matchKey] = (results.totalMatches[matchKey] || 0) + 1;
            });
            
            // 4. Ir a la pantalla de resultados del simulador
            updateState({ simResults: results, screen: 'simResults' });
        }


        // --- 3. FUNCIONES DE RENDERIZADO POR PANTALLA ---

        function renderContinentScreen() {
            const html = `
                <div class="screen active" id="continent-screen">
                    <div class="text-center mb-12 pt-6">
                        <h1 class="text-4xl font-extrabold text-yellow-300 mb-6 tracking-tight">GLOBAL LOTTO STRATEGY</h1>
                        <p class="text-gray-400 text-lg">Select Your Continent or Run Simulator</p>
                    </div>
                    
                    <div class="mb-8 text-center">
                        <button 
                            onclick="goToSimSelection()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-extrabold text-2xl py-4 px-12 rounded-full transition-colors duration-200 shadow-xl shadow-blue-600/50 icon-sim transform hover:scale-105"
                        >
                            Simulador de Rendimiento
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${Object.keys(LOTTERIES).map(continent => `
                            <button
                                onclick="updateState({ screen: 'country', selectedContinent: '${continent}' })"
                                class="bg-gray-800/70 backdrop-blur-sm border border-gray-700 hover:border-yellow-500 hover:bg-gray-700/80 transition-all duration-300 p-7 rounded-2xl shadow-lg transform hover:scale-[1.02] text-left"
                            >
                                <div class="flex items-center space-x-4">
                                    <span class="icon-globe text-2xl text-yellow-500"></span>
                                    <h2 class="text-2xl font-bold">${continent}</h2>
                                    <span class="ml-auto icon-right text-yellow-500"></span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderCountryScreen() {
            const continent = state.selectedContinent;
            const countries = LOTTERIES[continent];
            
            const html = `
                <div class="screen active" id="country-screen">
                    <button onclick="backToContinentScreen()" class="mb-6 inline-flex items-center text-yellow-500 hover:text-yellow-400 icon-left font-semibold">Back to Continents</button>
                    
                    <h1 class="text-3xl font-extrabold text-yellow-300 mb-8">${continent} Lotteries</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${Object.keys(countries).map(countryKey => {
                            const countryData = countries[countryKey];
                            return `
                                <div class="bg-gray-800/70 backdrop-blur-sm border border-gray-700 rounded-2xl p-6 shadow-lg">
                                    <div class="flex items-center mb-4 space-x-3">
                                        <span class="flag-icon">${countryData.flag}</span>
                                        <h2 class="text-2xl font-bold text-gray-100">${countryData.nativeName}</h2>
                                    </div>
                                    <ul class="space-y-3">
                                        ${countryData.lotteries.map(lotto => `
                                            <li>
                                                <button
                                                    onclick="updateState({ screen: 'baseNumberCount', selectedCountry: '${countryKey}', selectedLottery: LOTTERIES['${continent}']['${countryKey}'].lotteries.find(l => l.name === '${lotto.name}') })"
                                                    class="w-full bg-gray-700/50 hover:bg-yellow-600/50 text-gray-200 hover:text-white transition-colors duration-200 p-3 rounded-lg flex justify-between items-center"
                                                >
                                                    <span>${lotto.name}</span>
                                                    <span class="icon-right text-yellow-400"></span>
                                                </button>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }
        
        function renderBaseNumberCountScreen() {
            const lotto = state.selectedLottery;
            const isPick5 = lotto.type === 'pick5';
            const availableCounts = Object.keys(isPick5 ? FORMULAS_PICK5 : FORMULAS_PICK6).map(Number).sort((a,b) => a-b);
            const backAction = `updateState({ screen: 'country', selectedLottery: null })`;

            const html = `
                <div class="screen active" id="base-count-screen">
                    <button onclick="${backAction}" class="mb-6 inline-flex items-center text-yellow-500 hover:text-yellow-400 icon-left font-semibold">Back to Lotteries</button>
                    
                    <h1 class="text-3xl font-extrabold text-yellow-300 mb-3">${lotto.name} (${lotto.type.toUpperCase()})</h1>
                    <p class="text-gray-400 mb-8">Base Range: 1-${lotto.range}. ${lotto.extra ? `Extra Ball Range: 1-${lotto.extra.range}.` : ''}</p>
                    
                    <h2 class="text-2xl font-semibold mb-4 text-gray-300">1. Select Number of Base Bets (T)</h2>
                    <p class="text-gray-500 mb-6">Choose how many numbers (T) you want to use for the pyramidal reduction (T numbers will generate ${isPick5 ? 'Pick 5' : 'Pick 6'} combinations).</p>

                    <div class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-4">
                        ${availableCounts.map(count => `
                            <button
                                onclick="updateState({ baseNumberCount: ${count}, baseNumbers: [], screen: 'numberSelection' })"
                                class="bg-gray-700/50 hover:bg-yellow-500 hover:text-gray-900 transition-colors duration-200 p-4 rounded-lg font-bold text-xl shadow-md transform hover:scale-105"
                            >
                                T=${count}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }
        
        function renderNumberSelectionScreen() {
            const lotto = state.selectedLottery;
            const count = state.baseNumberCount;
            const selectedNumbers = state.baseNumbers;
            const maxRange = lotto.range;
            const backAction = `updateState({ screen: 'baseNumberCount', baseNumberCount: 0 })`;
            const formula = lotto.type === 'pick5' ? FORMULAS_PICK5[count] : FORMULAS_PICK6[count];
            const combinationsCount = formula ? formula.length : 0;

            const isComplete = selectedNumbers.length === count;

            const html = `
                <div class="screen active" id="number-selection-screen">
                    <button onclick="${backAction}" class="mb-6 inline-flex items-center text-yellow-500 hover:text-yellow-400 icon-left font-semibold">Back to Base Count</button>
                    
                    <h1 class="text-3xl font-extrabold text-yellow-300 mb-3">${lotto.name} - T=${count}</h1>
                    <p class="text-gray-400 mb-4">Select exactly ${count} Base Numbers from 1 to ${maxRange}.</p>
                    
                    <div class="p-4 bg-gray-800 rounded-lg shadow-inner mb-6">
                        <h2 class="text-xl font-semibold text-yellow-400 mb-2">Selected Numbers (${selectedNumbers.length}/${count}):</h2>
                        <div class="flex flex-wrap items-center">
                            ${selectedNumbers.length > 0 ? selectedNumbers.map(num => `
                                <div class="selected-number-display cursor-pointer" onclick="removeBaseNumber(${num})" title="Click to remove">${num}</div>
                            `).join('') : '<p class="text-gray-500">No numbers selected yet.</p>'}
                        </div>
                        ${isComplete ? `<p class="mt-4 text-green-400 icon-check font-bold">Selection complete! ${combinationsCount} combinations generated.</p>` : ''}
                    </div>

                    <div class="flex justify-between items-center mb-6">
                        <button onclick="generateMainBets()" ${isComplete ? '' : 'disabled'} class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-full transition-colors duration-200 shadow-md disabled:opacity-50 icon-magic">
                            Generate Combinations (${combinationsCount})
                        </button>
                        <button onclick="updateState({ baseNumbers: getRandomUniqueNumbers(${count}, ${maxRange}) })" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-3 px-6 rounded-full transition-colors duration-200 shadow-md icon-dice">
                            Auto-Select
                        </button>
                    </div>

                    <h2 class="text-2xl font-semibold mb-4 text-gray-300">Number Grid (1 to ${maxRange})</h2>
                    <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 xl:grid-cols-14 gap-2">
                        ${Array.from({ length: maxRange }, (_, i) => i + 1).map(num => `
                            <button
                                onclick="addBaseNumber(${num})"
                                class="grid-number-button ${selectedNumbers.includes(num) ? 'selected' : ''}"
                                ${!selectedNumbers.includes(num) && selectedNumbers.length >= count ? 'disabled' : ''}
                            >
                                ${num}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }
        
        function renderExtraNumbersSelectionScreen() {
            const lotto = state.selectedLottery;
            const extra = lotto.extra;
            const count = extra.count;
            const selectedNumbers = state.extraNumbers;
            const maxRange = extra.range;
            const backAction = `updateState({ screen: 'numberSelection', finalCombinations: null })`;
            const isComplete = selectedNumbers.length === count;

            const html = `
                <div class="screen active" id="extra-number-selection-screen">
                    <button onclick="${backAction}" class="mb-6 inline-flex items-center text-yellow-500 hover:text-yellow-400 icon-left font-semibold">Back to Main Selection</button>
                    
                    <h1 class="text-3xl font-extrabold text-yellow-300 mb-3">${lotto.name} - ${extra.name} Selection</h1>
                    <p class="text-gray-400 mb-4">Select exactly ${count} ${extra.name} from 1 to ${maxRange}.</p>

                    <div class="p-4 bg-gray-800 rounded-lg shadow-inner mb-6">
                        <h2 class="text-xl font-semibold text-yellow-400 mb-2">Selected ${extra.name} (${selectedNumbers.length}/${count}):</h2>
                        <div class="flex flex-wrap items-center">
                            ${selectedNumbers.length > 0 ? selectedNumbers.map(num => `
                                <div class="extra-ball-display cursor-pointer bg-red-600" onclick="removeExtraNumber(${num})" title="Click to remove">${num}</div>
                            `).join('') : '<p class="text-gray-500">No extra numbers selected yet.</p>'}
                        </div>
                        ${isComplete ? `<p class="mt-4 text-green-400 icon-check font-bold">Extra selection complete!</p>` : ''}
                    </div>

                    <div class="flex justify-between items-center mb-6">
                        <button onclick="calculateAndGoToResults()" ${isComplete ? '' : 'disabled'} class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-full transition-colors duration-200 shadow-md disabled:opacity-50 icon-magic">
                            Generate Final Bets
                        </button>
                        <button onclick="autoSelectExtraNumbers()" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-3 px-6 rounded-full transition-colors duration-200 shadow-md icon-dice">
                            Auto-Select Extra
                        </button>
                    </div>

                    <h2 class="text-2xl font-semibold mb-4 text-gray-300">${extra.name} Grid (1 to ${maxRange})</h2>
                    <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 xl:grid-cols-14 gap-2">
                        ${Array.from({ length: maxRange }, (_, i) => i + 1).map(num => `
                            <button
                                onclick="addExtraNumber(${num})"
                                class="grid-extra-number-button ${selectedNumbers.includes(num) ? 'selected' : ''}"
                                ${!selectedNumbers.includes(num) && selectedNumbers.length >= count ? 'disabled' : ''}
                            >
                                ${num}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }
        
        function renderResultsScreen() {
            const lotto = state.selectedLottery;
            const combinations = state.finalCombinations;
            const extraNumbers = state.extraNumbers;
            const hasExtra = extraNumbers.length > 0;
            const backAction = hasExtra ? `updateState({ screen: 'extraNumberSelection', finalCombinations: null })` : `updateState({ screen: 'numberSelection', finalCombinations: null })`;

            const html = `
                <div class="screen active" id="results-screen">
                    <button onclick="${backAction}" class="mb-6 inline-flex items-center text-yellow-500 hover:text-yellow-400 icon-left font-semibold">Back to Number Selection</button>
                    
                    <h1 class="text-3xl font-extrabold text-green-400 mb-3 icon-check">Combinations Generated Successfully!</h1>
                    <p class="text-gray-400 mb-4">Lottery: ${lotto.name} | Base Numbers (T=${state.baseNumberCount}): ${state.baseNumbers.join(', ')}</p>

                    ${hasExtra ? `
                        <div class="p-4 bg-red-800/50 rounded-lg shadow-inner mb-6 flex items-center">
                            <h2 class="text-xl font-semibold text-red-300 mr-4">${lotto.extra.name}:</h2>
                            ${extraNumbers.map(num => `<div class="extra-ball-display bg-red-600">${num}</div>`).join('')}
                        </div>
                    ` : ''}

                    <div class="p-4 bg-gray-800 rounded-lg shadow-inner mb-6">
                        <h2 class="text-xl font-semibold text-yellow-400 mb-2">Total Bets: ${combinations.length}</h2>
                        <div class="flex justify-between items-center">
                            <p class="text-gray-300">Pyramidal reduction complete.</p>
                            <button onclick="exportToTxt()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 shadow-md icon-export">
                                Export to TXT
                            </button>
                        </div>
                    </div>

                    <h2 class="text-2xl font-semibold mb-4 text-gray-300">Generated Bets:</h2>
                    <div class="space-y-3 max-h-96 overflow-y-auto p-3 bg-gray-900 rounded-lg border border-gray-700">
                        ${combinations.map((bet, index) => {
                            const mainNumbers = bet.map(n => `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-yellow-500 text-gray-900 font-bold text-sm">${n}</span>`).join('');
                            const extraPart = hasExtra ? extraNumbers.map(n => `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-600 text-white font-bold text-sm ml-2">${n}</span>`).join('') : '';
                            return `
                                <div class="flex items-center p-2 bg-gray-800 rounded-md">
                                    <span class="text-sm font-mono mr-4 text-gray-500">${index + 1}.</span>
                                    ${mainNumbers}
                                    ${extraPart}
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="mt-8 text-center">
                        <button onclick="resetApp()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-colors duration-200 shadow-xl icon-dice">
                            Start New Generation
                        </button>
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        // --- SIMULATOR SCREENS ---
        
        function renderSimLotterySelectionScreen() {
            // Reutiliza la l√≥gica de renderCountryScreen para la selecci√≥n inicial del simulador
            
            const html = `
                <div class="screen active" id="sim-lottery-selection-screen">
                    <button onclick="backToContinentScreen()" class="mb-6 inline-flex items-center text-yellow-500 hover:text-yellow-400 icon-left font-semibold">Back to Home</button>
                    
                    <h1 class="text-3xl font-extrabold text-blue-400 mb-8 icon-sim">Simulator: Select Lottery</h1>
                    
                    <p class="text-gray-400 mb-6">Select the lottery model to define the rules for the simulation.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${Object.keys(LOTTERIES).map(continentKey => {
                            const countries = LOTTERIES[continentKey];
                            return Object.keys(countries).map(countryKey => {
                                const countryData = countries[countryKey];
                                return countryData.lotteries.map(lotto => `
                                    <button
                                        onclick="updateState({ 
                                            screen: 'simBaseCount', 
                                            simLottery: LOTTERIES['${continentKey}']['${countryKey}'].lotteries.find(l => l.name === '${lotto.name}')
                                        })"
                                        class="w-full bg-gray-700/50 hover:bg-blue-600/50 text-gray-200 hover:text-white transition-colors duration-200 p-3 rounded-lg flex justify-between items-center border border-gray-700 hover:border-blue-500 shadow-md"
                                    >
                                        <div class="flex items-center space-x-2">
                                            <span class="flag-icon text-lg">${countryData.flag}</span>
                                            <span>${lotto.name}</span>
                                        </div>
                                        <span class="text-sm text-gray-400">${lotto.type.toUpperCase()} (1-${lotto.range}${lotto.extra ? ` + ${lotto.extra.count}x1-${lotto.extra.range}` : ''})</span>
                                    </button>
                                `).join('');
                            }).join('');
                        }).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }
        
        function renderSimBaseCountScreen() {
            const lotto = state.simLottery;
            const isPick5 = lotto.type === 'pick5';
            const availableCounts = Object.keys(isPick5 ? FORMULAS_PICK5 : FORMULAS_PICK6).map(Number).sort((a,b) => a-b);
            const backAction = `goToSimSelection()`;

            const html = `
                <div class="screen active" id="sim-base-count-screen">
                    <button onclick="${backAction}" class="mb-6 inline-flex items-center text-blue-500 hover:text-blue-400 icon-left font-semibold">Back to Lottery Selection</button>
                    
                    <h1 class="text-3xl font-extrabold text-blue-400 mb-3 icon-calc">Simulator: ${lotto.name}</h1>
                    <p class="text-gray-400 mb-8">Base Range: 1-${lotto.range}. ${lotto.extra ? `Extra Ball Range: 1-${lotto.extra.range}.` : ''}</p>
                    
                    <h2 class="text-2xl font-semibold mb-4 text-gray-300">1. Select Number of Base Bets (T)</h2>
                    <p class="text-gray-500 mb-6">Choose the size of the initial pool (T numbers) that your bets will be derived from.</p>

                    <div class="grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-8 gap-4">
                        ${availableCounts.map(count => `
                            <button
                                onclick="updateState({ simBaseCount: ${count}, simBaseNumbers: [], simWinningNumbers: [], simWinningExtraNumbers: [], simResults: null, screen: 'simNumberInput' })"
                                class="bg-gray-700/50 hover:bg-blue-500 hover:text-gray-900 transition-colors duration-200 p-4 rounded-lg font-bold text-xl shadow-md transform hover:scale-105"
                            >
                                T=${count}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderSimNumberInputScreen() {
            const lotto = state.simLottery;
            const baseCount = state.simBaseCount;
            const maxRange = lotto.range;
            const requiredMainCount = lotto.type === 'pick5' ? 5 : 6;
            const hasExtra = lotto.extra;
            
            const baseNumbers = state.simBaseNumbers;
            const winningNumbers = state.simWinningNumbers;
            const winningExtraNumbers = state.simWinningExtraNumbers;

            const isBaseComplete = baseNumbers.length === baseCount;
            const isWinningComplete = winningNumbers.length === requiredMainCount;
            const isExtraComplete = !hasExtra || winningExtraNumbers.length === lotto.extra.count;
            const isReadyToSimulate = isBaseComplete && isWinningComplete && isExtraComplete;

            const combinationsCount = FORMULAS_PICK5[baseCount] ? FORMULAS_PICK5[baseCount].length : (FORMULAS_PICK6[baseCount] ? FORMULAS_PICK6[baseCount].length : 0);
            
            const html = `
                <div class="screen active" id="sim-number-input-screen">
                    <button onclick="updateState({ screen: 'simBaseCount' })" class="mb-6 inline-flex items-center text-blue-500 hover:text-blue-400 icon-left font-semibold">Back to Base Count</button>
                    
                    <h1 class="text-3xl font-extrabold text-blue-400 mb-3 icon-calc">Simulator: ${lotto.name} (T=${baseCount})</h1>
                    <p class="text-gray-400 mb-6">Generated bets: ${combinationsCount}.</p>
                    
                    <div class="mb-8 p-4 bg-gray-800 rounded-lg shadow-inner border-l-4 ${isBaseComplete ? 'border-green-500' : 'border-blue-500'}">
                        <h2 class="text-xl font-semibold text-blue-300 mb-2">1. Select ${baseCount} Base Numbers (T)</h2>
                        <div class="flex flex-wrap items-center mb-4">
                            ${baseNumbers.length > 0 ? baseNumbers.map(num => `
                                <div class="sim-number-button selected bg-blue-500 cursor-pointer" onclick="handleSimNumberSelection(${num}, 'base')" title="Click to remove">${num}</div>
                            `).join('') : '<p class="text-gray-500">Select the T numbers pool.</p>'}
                        </div>
                        <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-2 max-h-48 overflow-y-auto p-2">
                            ${Array.from({ length: maxRange }, (_, i) => i + 1).map(num => `
                                <button
                                    onclick="handleSimNumberSelection(${num}, 'base')"
                                    class="grid-number-button ${baseNumbers.includes(num) ? 'selected' : ''}"
                                    ${!baseNumbers.includes(num) && baseNumbers.length >= baseCount ? 'disabled' : ''}
                                >
                                    ${num}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="mb-8 p-4 bg-gray-800 rounded-lg shadow-inner border-l-4 ${isWinningComplete ? 'border-green-500' : 'border-yellow-500'}">
                        <h2 class="text-xl font-semibold text-yellow-300 mb-2">2. Select ${requiredMainCount} Winning Numbers</h2>
                        <p class="text-gray-500 mb-4">These must be selected from the T numbers above.</p>
                        <div class="flex flex-wrap items-center mb-4">
                            ${winningNumbers.length > 0 ? winningNumbers.map(num => `
                                <div class="sim-number-button selected bg-emerald-500 cursor-pointer" onclick="handleSimNumberSelection(${num}, 'winning')" title="Click to remove">${num}</div>
                            `).join('') : '<p class="text-gray-500">Select the actual winning numbers.</p>'}
                        </div>
                        <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-2 max-h-48 overflow-y-auto p-2">
                            ${baseNumbers.map(num => `
                                <button
                                    onclick="handleSimNumberSelection(${num}, 'winning')"
                                    class="sim-number-button ${winningNumbers.includes(num) ? 'selected' : ''}"
                                    ${!winningNumbers.includes(num) && winningNumbers.length >= requiredMainCount ? 'disabled' : ''}
                                >
                                    ${num}
                                </button>
                            `).join('')}
                            ${baseNumbers.length === 0 ? '<p class="text-gray-500">Select Base Numbers first.</p>' : ''}
                        </div>
                    </div>

                    ${hasExtra ? `
                        <div class="mb-8 p-4 bg-gray-800 rounded-lg shadow-inner border-l-4 ${isExtraComplete ? 'border-green-500' : 'border-red-500'}">
                            <h2 class="text-xl font-semibold text-red-300 mb-2">3. Select ${lotto.extra.count} Winning ${lotto.extra.name} (1-${lotto.extra.range})</h2>
                            <div class="flex flex-wrap items-center mb-4">
                                ${winningExtraNumbers.length > 0 ? winningExtraNumbers.map(num => `
                                    <div class="extra-ball-display bg-red-600 cursor-pointer" onclick="handleSimExtraNumberSelection(${num})" title="Click to remove">${num}</div>
                                `).join('') : '<p class="text-gray-500">Select the winning extra number(s).</p>'}
                            </div>
                            <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-2 max-h-48 overflow-y-auto p-2">
                                ${Array.from({ length: lotto.extra.range }, (_, i) => i + 1).map(num => `
                                    <button
                                        onclick="handleSimExtraNumberSelection(${num})"
                                        class="grid-extra-number-button ${winningExtraNumbers.includes(num) ? 'selected' : ''}"
                                        ${!winningExtraNumbers.includes(num) && winningExtraNumbers.length >= lotto.extra.count ? 'disabled' : ''}
                                    >
                                        ${num}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="mt-8 text-center">
                        <button onclick="goToSimResults()" ${isReadyToSimulate ? '' : 'disabled'} class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-12 rounded-full transition-colors duration-200 shadow-xl disabled:opacity-50 icon-sim">
                            Run Simulation
                        </button>
                    </div>

                </div>
            `;
            appContainer.innerHTML = html;
        }

        function renderSimResultsScreen() {
            const lotto = state.simLottery;
            const results = state.simResults;
            const hasExtra = lotto.extra;
            const requiredMainCount = lotto.type === 'pick5' ? 5 : 6;
            const requiredExtraCount = hasExtra ? lotto.extra.count : 0;
            const winningMainNumbers = state.simWinningNumbers.join(', ');
            const winningExtraNumbers = hasExtra ? state.simWinningExtraNumbers.join(', ') : 'N/A';
            
            const sortedTotalMatchesKeys = Object.keys(results.totalMatches).sort((a, b) => {
                const [aMain, aExtra] = a.split('+').map(Number);
                const [bMain, bExtra] = b.split('+').map(Number);
                if (bMain !== aMain) return bMain - aMain; // Sort descending by main hits
                return bExtra - aExtra; // Then descending by extra hits
            });
            
            const html = `
                <div class="screen active" id="sim-results-screen">
                    <button onclick="updateState({ screen: 'simNumberInput' })" class="mb-6 inline-flex items-center text-blue-500 hover:text-blue-400 icon-left font-semibold">Back to Input</button>
                    
                    <h1 class="text-3xl font-extrabold text-green-400 mb-3 icon-check">Simulation Complete!</h1>
                    <p class="text-gray-400 mb-6">Lottery: ${lotto.name} | Base Numbers (T=${state.simBaseCount})</p>

                    <div class="p-4 bg-yellow-900/40 rounded-lg shadow-inner mb-6">
                        <h2 class="text-xl font-semibold text-yellow-400 mb-2">Simulation Summary</h2>
                        <p class="text-gray-300">Total Bets Generated (Pyramidal Reduction): <strong>${results.totalBets}</strong></p>
                        <p class="text-gray-300">Winning Main Numbers (${requiredMainCount}): <strong>${winningMainNumbers}</strong></p>
                        ${hasExtra ? `<p class="text-gray-300">Winning ${lotto.extra.name} (${requiredExtraCount}): <strong>${winningExtraNumbers}</strong></p>` : ''}
                    </div>

                    <h2 class="text-2xl font-semibold mb-4 text-gray-300">Detailed Hit Analysis (Bet Count)</h2>
                    <div class="bg-gray-800 rounded-lg overflow-hidden shadow-xl">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-bold text-gray-200 uppercase tracking-wider">Main Hits</th>
                                    ${hasExtra ? `<th class="px-4 py-3 text-left text-sm font-bold text-gray-200 uppercase tracking-wider">${lotto.extra.name} Hits</th>` : ''}
                                    <th class="px-4 py-3 text-right text-sm font-bold text-gray-200 uppercase tracking-wider">Bets Matched</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                ${sortedTotalMatchesKeys.map(key => {
                                    const [main, extra] = key.split('+');
                                    const count = results.totalMatches[key];
                                    return `
                                        <tr class="bg-gray-900 hover:bg-gray-800 transition-colors">
                                            <td class="px-4 py-3 whitespace-nowrap text-lg font-bold ${Number(main) === requiredMainCount ? 'text-green-400' : 'text-yellow-400'}">${main}/${requiredMainCount}</td>
                                            ${hasExtra ? `<td class="px-4 py-3 whitespace-nowrap text-lg font-bold ${Number(extra) === requiredExtraCount ? 'text-green-400' : 'text-red-400'}">${extra}/${requiredExtraCount}</td>` : ''}
                                            <td class="px-4 py-3 whitespace-nowrap text-right text-lg font-bold text-white">${count}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-8 text-center">
                        <button onclick="resetApp()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-colors duration-200 shadow-xl icon-dice">
                            Start New Simulation
                        </button>
                    </div>
                </div>
            `;
            appContainer.innerHTML = html;
        }

        // --- 4. RENDERIZADO INICIAL ---

        function renderApp() {
            switch (state.screen) {
                case 'continent':
                    renderContinentScreen();
                    break;
                case 'country':
                    renderCountryScreen();
                    break;
                case 'baseNumberCount':
                    renderBaseNumberCountScreen();
                    break;
                case 'numberSelection':
                    renderNumberSelectionScreen();
                    break;
                case 'extraNumberSelection':
                    renderExtraNumbersSelectionScreen();
                    break;
                case 'results':
                    renderResultsScreen();
                    break;
                case 'simLotterySelection':
                    renderSimLotterySelectionScreen();
                    break;
                case 'simBaseCount':
                    renderSimBaseCountScreen();
                    break;
                case 'simNumberInput':
                    renderSimNumberInputScreen();
                    break;
                case 'simResults':
                    renderSimResultsScreen();
                    break;
                default:
                    renderContinentScreen();
            }
        }

        // --- 5. REGISTRO DEL SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }

        // Initial render
        renderApp();
    </script>
</body>
</html>
